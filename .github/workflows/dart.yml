name: Flutter Build APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # âœ… Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ±Ø³
      - name: Checkout source
        uses: actions/checkout@v4

      # âœ… Ù†ØµØ¨ Flutter Ù†Ø³Ø®Ù‡ Ù…Ø´Ø®Øµ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.2"

      # âœ… Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´ Ù¾Ú©ÛŒØ¬ flutter_native_timezone
      - name: Remove flutter_native_timezone from pub cache
        run: rm -rf $HOME/.pub-cache/hosted/pub.dev/flutter_native_timezone*

      # âœ… Ù†ØµØ¨ dependencies
      - name: Install dependencies
        run: flutter pub get

      # ğŸ”§ Ø§ØµÙ„Ø§Ø­ Kotlin version Ùˆ namespace Ù¾Ú©ÛŒØ¬ flutter_native_timezone
      - name: Fix flutter_native_timezone Kotlin and namespace
        run: |
          # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± Ø¯Ù‚ÛŒÙ‚ Ù¾Ú©ÛŒØ¬
          PKG_DIR=$(ls -d $HOME/.pub-cache/hosted/pub.dev/flutter_native_timezone-*/android)
          echo "Using package dir: $PKG_DIR"
          # Ø§Ø±ØªÙ‚Ø§ Kotlin Ø¨Ù‡ Ù†Ø³Ø®Ù‡ 1.8.22
          sed -i 's/kotlin-gradle-plugin:1.3.50/kotlin-gradle-plugin:1.8.22/' $PKG_DIR/build.gradle
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† namespace
          sed -i '/android {/a \    namespace "com.example.flutter_native_timezone"' $PKG_DIR/build.gradle

      # âœ… Ø¢Ù†Ø§Ù„ÛŒØ² Ù¾Ø±ÙˆÚ˜Ù‡ (Ø®Ø·Ø§ Ù†Ú©Ù†Ø¯)
      - name: Analyze project
        run: flutter analyze || true

      # âœ… ØªØ³Øªâ€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      - name: Run tests (optional)
        run: flutter test || true

      # âœ… Ø³Ø§Ø®Øª APK Ø±ÛŒÙ„ÛŒØ²
      - name: Build APK
        run: flutter build apk --release

      # âœ… Ø¢Ù¾Ù„ÙˆØ¯ APKÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† artifact
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apks
          path: build/app/outputs/flutter-apk/*.apk

